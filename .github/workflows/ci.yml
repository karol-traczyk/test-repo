name: CI

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]

jobs:
  test:
    name: Lint, Format, Test & Coverage
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Deno
        uses: denoland/setup-deno@v1
        with:
          deno-version: v1.x

      - name: Verify formatting
        run: deno fmt --check

      - name: Run linter
        run: deno lint

      - name: Run tests with coverage
        run: deno test --allow-net --allow-env --coverage=coverage

      - name: Generate coverage report
        run: deno coverage coverage --lcov --output=coverage.lcov

      - name: Generate coverage summary
        run: |
          echo "## Coverage Report" >> $GITHUB_STEP_SUMMARY
          deno coverage coverage
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Coverage report generated successfully!" >> $GITHUB_STEP_SUMMARY

      - name: Upload coverage reports to Codecov
        uses: codecov/codecov-action@v4
        with:
          file: ./coverage.lcov
          fail_ci_if_error: false
        continue-on-error: true

      - name: Check coverage threshold
        run: |
          COVERAGE=$(deno coverage coverage --json | grep -oP '"percentage":\s*\K[0-9.]+' | head -1)
          echo "Current coverage: $COVERAGE%"
          if (( $(echo "$COVERAGE < 85" | bc -l) )); then
            echo "❌ Coverage is below 85% threshold"
            exit 1
          else
            echo "✅ Coverage meets 85% threshold"
          fi
